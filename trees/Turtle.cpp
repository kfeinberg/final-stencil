#include "Turtle.h"

Turtle::Turtle()
{

}

/**
 * @brief The LSystem class
 *
 * Symbolic explanations:
 * F move forward by d units
 * + yaw left by angle δ
 * - yaw right by angle δ
 * & pitch down by angle δ
 * ∧ pitch up by angle δ
 * \ roll left by angle δ
 * / roll right by angle δ
 * [ start of new branch (push the state onto the stack)
 * ] end of branch (pop the state from the stack and old state becomes current state)
 * > : decrease thickness (by percent of its own)
 * < : increase thickness (by percent of its own)
 * = : set thickness (to percentage of length)
 * * : draw leaf
 */


/**
 * @brief Iterates through string and performs actions.
 * @param input string generated by L-system.
 */
void Turtle::parseInput(std::string input) {
    for (std::string::size_type i = 0; i < input.size(); i++) {
        char c = input[i];
        switch(c) {
            case 'F':
                moveForward();
                break;
            case '+':
                m_yaw += theta;
                break;
            case '-':
                m_yaw -= theta;
                break;
            case '&':
                m_pitch += theta;
                break;
            case '^':
                m_pitch -= theta;
                break;
            case '\\':
                m_roll += theta;
                break;
            case '/':
                m_roll -= theta;
                break;
            case '[':
                this->save();
                break;
            case ']':
                this->restore();
                break;
            case '>':
                m_thickness *= dec_mult;
                break;
            case '<':
                m_thickness *= inc_mult;
                break;
            case '=':
                m_thickness = 1;
                break;
            case '*':
                drawLeaf();
                break;
        }
    }
}

/**
 * @brief Draw cylinder and move turtle forward.
 */
void Turtle::moveForward() {

    // basic cylinder
    Cylinder c(10, 10);

    // transformation matrix to correct turtle position
    glm::mat4x4 mat = currTransMatrix();

    // move whole shape to correct location
    // m_phongShader->setUniform("m", mat);
    c.draw();

    // calculate forward vector based on yaw, pitch, deg
    // source: https://stackoverflow.com/questions/1568568/how-to-convert-euler-angles-to-directional-vector
    float fx = cos(m_yaw) * cos(m_pitch);
    float fy = sin(m_yaw) * cos(m_pitch);
    float fz = sin(m_pitch);

    // update position vector with forward step
    glm::vec3 vec = glm::normalize(glm::vec3(fx, fy, fz));
    m_pos += vec;
}

/**
 * @brief Draws leaf at current turtle location.
 */
void Turtle::drawLeaf() {
    Cylinder c(10, 10); //TODO: Find better leaf shape, transform to pos
    c.draw();
}

/**
 * @brief Save current turtle state on stack.
 */
void Turtle::save() {
    m_states.push(*this);
}

/**
 * @brief End branch by restoring previous turtle state from stack.
 */
void Turtle::restore() {
    Turtle t = m_states.top();
    m_states.pop();

    m_pos = t.m_pos;
    m_thickness = t.m_thickness;
    m_pitch = t.m_pitch;
    m_yaw = t.m_yaw;
    m_roll = t.m_roll;
}

glm::mat4x4 Turtle::currTransMatrix() {
    glm::mat4x4 scale = glm::scale(glm::vec3(0.0f, f_dist, 0.0f)); // scales cylinder in y direction by f_dist

    glm::mat4x4 yaw = glm::rotate(m_yaw, glm::vec3(0, 0, 1));
    glm::mat4x4 pitch = glm::rotate(m_pitch, glm::vec3(0, 1, 0));
    glm::mat4x4 roll = glm::rotate(m_roll, glm::vec3(1, 0, 0));
    glm::mat4x4 rotate = yaw * pitch * roll;

    glm::mat4 trans = glm::translate(glm::vec3(m_pos.x, m_pos.y, m_pos.z)); // translates cylinder to current turtle

    return scale * rotate * trans;
}
